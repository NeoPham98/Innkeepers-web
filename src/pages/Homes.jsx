import React, { useEffect, useMemo, useState } from 'react';
import { Link, useNavigate, useParams } from 'react-router-dom';
import { supabase } from '../lib/supabase.js';

export const Homes = () => {
  const { accountId } = useParams();
  const navigate = useNavigate();
  const [homes, setHomes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [monthlyRevenue, setMonthlyRevenue] = useState({});
  const [invoiceCounts, setInvoiceCounts] = useState({});

  const fetchMonthlyRevenueByHome = async () => {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const from = new Date(Date.UTC(currentYear, currentMonth, 1)).toISOString();
    const to = new Date(Date.UTC(currentYear, currentMonth + 1, 1)).toISOString();

    const { data, error } = await supabase
      .from('Invoice')
      .select('id_home,total_amount,created_at')
      .gte('created_at', from)
      .lt('created_at', to);
    if (error) return {};

    return (data || []).reduce((acc, inv) => {
      const amount = parseFloat(inv.total_amount) || 0;
      acc[inv.id_home] = (acc[inv.id_home] || 0) + amount;
      return acc;
    }, {});
  };

  const fetchInvoiceCountByHome = async () => {
    // L·∫•y t·∫•t c·∫£ h√≥a ƒë∆°n c·ªßa c√°c nh√† thu·ªôc account n√†y
    const { data: homesData, error: homesError } = await supabase
      .from('Home')
      .select('id_home')
      .eq('id_account', accountId);
    
    if (homesError) return {};

    const homeIds = homesData.map(home => home.id_home);
    
    if (homeIds.length === 0) return {};

    const { data, error } = await supabase
      .from('Invoice')
      .select('id_invoice, id_home')
      .in('id_home', homeIds);
    
    if (error) return {};

    return (data || []).reduce((acc, inv) => {
      acc[inv.id_home] = (acc[inv.id_home] || 0) + 1;
      return acc;
    }, {});
  };

  const load = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('Home')
        .select('*')
        .eq('id_account', accountId)
        .order('created_at', { ascending: false });
      if (error) throw error;

      const revenue = await fetchMonthlyRevenueByHome();
      const counts = await fetchInvoiceCountByHome();
      setMonthlyRevenue(revenue);
      setInvoiceCounts(counts);
      setHomes(data || []);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    load();
  }, [accountId]);

  const format = (n) => new Intl.NumberFormat('vi-VN').format(n);
  const monthName = useMemo(() => `Th√°ng ${new Date().getMonth() + 1}`, []);

  // Calculate statistics
  const totalHomes = homes.length;
  const totalRooms = homes.reduce((sum, home) => sum + (home.room_total || 0), 0);
  const totalEmptyRooms = homes.reduce((sum, home) => sum + (home.room_total_empty || 0), 0);
  const totalRevenue = Object.values(monthlyRevenue).reduce((sum, rev) => sum + rev, 0);
  const occupancyRate = totalRooms > 0 ? ((totalRooms - totalEmptyRooms) / totalRooms * 100).toFixed(1) : 0;

  if (loading) {
    return (
      <div className="loading">
        ƒêang t·∫£i d·ªØ li·ªáu...
      </div>
    );
  }

  return (
    <div className="fade-in">
      {/* Page Header */}
      <div className="page-header">
        <h1 className="page-title">Qu·∫£n l√Ω nh√† tr·ªç</h1>
        <p className="page-subtitle">
          T·ªïng quan v·ªÅ c√°c nh√† tr·ªç v√† th·ªëng k√™ chi ti·∫øt v·ªÅ t√¨nh h√¨nh kinh doanh
        </p>
      </div>

      {/* Dashboard Stats */}
      <div className="dashboard-grid">
        <div className="stat-card">
          <div className="stat-header">
            <span className="stat-title">T·ªïng s·ªë nh√†</span>
            <div className="stat-icon primary">üè†</div>
          </div>
          <div className="stat-value">{totalHomes}</div>
          <div className="stat-change">Nh√† tr·ªç ƒëang qu·∫£n l√Ω</div>
        </div>

        <div className="stat-card">
          <div className="stat-header">
            <span className="stat-title">T·ªïng s·ªë ph√≤ng</span>
            <div className="stat-icon info">üö™</div>
          </div>
          <div className="stat-value">{totalRooms}</div>
          <div className="stat-change">Ph√≤ng trong t·∫•t c·∫£ nh√†</div>
        </div>

        <div className="stat-card">
          <div className="stat-header">
            <span className="stat-title">T·ª∑ l·ªá l·∫•p ƒë·∫ßy</span>
            <div className="stat-icon warning">üìä</div>
          </div>
          <div className="stat-value">{occupancyRate}%</div>
          <div className="stat-change positive">
            {totalRooms - totalEmptyRooms}/{totalRooms} ph√≤ng ƒë√£ thu√™
          </div>
        </div>

        <div className="stat-card">
          <div className="stat-header">
            <span className="stat-title">Doanh thu {monthName}</span>
            <div className="stat-icon success">üí∞</div>
          </div>
          <div className="stat-value">{format(totalRevenue)} ‚Ç´</div>
          <div className="stat-change positive">T·ªïng thu nh·∫≠p th√°ng n√†y</div>
        </div>
      </div>

      {/* Toolbar */}
      <div className="toolbar">
        <div className="toolbar-left">
          <h2 className="text-2xl font-bold">Danh s√°ch nh√† tr·ªç</h2>
          <span className="text-muted">({totalHomes} nh√†)</span>
        </div>
        <div className="toolbar-right">
          <Link to={`/app/homes/${accountId}/new`} className="btn btn-primary btn-lg">
            <span>üèóÔ∏è</span>
            T·∫°o nh√† m·ªõi
          </Link>
        </div>
      </div>

      {/* Homes Grid */}
      <div className="grid grid-2">
        {homes.map((home, index) => (
          <div key={home.id_home} className="card fade-in" style={{ animationDelay: `${index * 0.1}s` }}>
            <div className="card-header">
              <div className="flex items-center justify-between">
                <h3 className="card-title">{home.home_name}</h3>
                <div className="flex gap-2">
                  <button 
                    onClick={() => navigate(`/app/homes/${accountId}/${home.id_home}/edit`)} 
                    className="btn btn-secondary btn-sm"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button 
                    onClick={async () => { 
                      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√† n√†y?')) {
                        await supabase.from('Home').delete().eq('id_home', home.id_home); 
                        load(); 
                        // Trigger refresh homes in AppShell
                        window.dispatchEvent(new CustomEvent('refreshHomes'));
                      }
                    }} 
                    className="btn btn-danger btn-sm"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            </div>
            <div className="card-body">
              <div className="flex items-center gap-3 mb-6">
                <div className="text-3xl">üìç</div>
                <p className="text-muted text-lg">{home.home_address}</p>
              </div>
              
              <div className="grid grid-4 mb-6">
                <div className="text-center p-4 bg-secondary rounded-xl">
                  <div className="text-2xl mb-2">üè†</div>
                  <div className="text-sm text-muted">T·ªïng ph√≤ng</div>
                  <div className="font-bold text-xl">{home.room_total || 0}</div>
                </div>
                <div className="text-center p-4 bg-warning rounded-xl">
                  <div className="text-2xl mb-2">üîì</div>
                  <div className="text-sm text-muted">Ph√≤ng tr·ªëng</div>
                  <div className="font-bold text-xl">{home.room_total_empty || 0}</div>
                </div>
                <div className="text-center p-4 bg-success rounded-xl">
                  <div className="text-2xl mb-2">üë•</div>
                  <div className="text-sm text-muted">ƒêang thu√™</div>
                  <div className="font-bold text-xl">{home.room_total - (home.room_total_empty || 0)}</div>
                </div>
                                 <div className="text-center p-4 bg-info rounded-xl">
                   <div className="text-2xl mb-2">üìã</div>
                   <div className="text-sm text-muted">H√≥a ƒë∆°n</div>
                   <div className="font-bold text-xl">{invoiceCounts[home.id_home] || 0}</div>
                 </div>
              </div>

              <div className="flex items-center justify-between p-4 bg-tertiary rounded-xl">
                <div>
                  <div className="text-sm text-muted">Doanh thu {monthName}</div>
                  <div className="font-bold text-2xl text-success">
                    {format(monthlyRevenue[home.id_home] || 0)} ‚Ç´
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-sm text-muted">T·ª∑ l·ªá l·∫•p ƒë·∫ßy</div>
                  <div className="font-bold text-lg">
                    {home.room_total > 0 
                      ? (((home.room_total - (home.room_total_empty || 0)) / home.room_total * 100).toFixed(1))
                      : 0}%
                  </div>
                </div>
              </div>
            </div>
            <div className="card-footer">
              <Link to={`/app/homes/${accountId}/${home.id_home}`} className="btn btn-primary w-full">
                üëÅÔ∏è Xem chi ti·∫øt
              </Link>
            </div>
          </div>
        ))}
      </div>

      {homes.length === 0 && (
        <div className="card text-center fade-in">
          <div className="card-body p-12">
            <div className="text-8xl mb-6">üè†</div>
            <h3 className="text-2xl font-bold mb-4">Ch∆∞a c√≥ nh√† tr·ªç n√†o</h3>
            <p className="text-muted text-lg mb-8 max-w-md mx-auto">
              B·∫Øt ƒë·∫ßu h√†nh tr√¨nh qu·∫£n l√Ω nh√† tr·ªç b·∫±ng c√°ch t·∫°o nh√† ƒë·∫ßu ti√™n
            </p>
            <Link to={`/app/homes/${accountId}/new`} className="btn btn-primary btn-lg">
              <span>üèóÔ∏è</span>
              T·∫°o nh√† ƒë·∫ßu ti√™n
            </Link>
          </div>
        </div>
      )}
    </div>
  );
};


